<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Dashboard - TodoKanban</title>
    <link rel="stylesheet" href="/static/css/reset.css">
    <link rel="stylesheet" href="/static/css/variables.css">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/components.css">
</head>
<body>
    <nav class="navbar">
        <div class="container navbar-content">
            <div class="navbar-brand">TodoKanban</div>
            <div class="navbar-nav">
                <span id="user-name" class="nav-link"></span>
                <button id="logout-btn" class="btn btn-secondary">Logout</button>
            </div>
        </div>
    </nav>

    <main class="container" style="padding-top: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h1 style="font-size: 2rem; font-weight: 700;">My Boards</h1>
            <button id="create-board-btn" class="btn btn-primary">+ Create Board</button>
        </div>

        <div id="boards-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
            <div class="spinner"></div>
        </div>
    </main>

    <!-- Create Board Modal -->
    <div id="create-board-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Create New Board</h2>
                <button class="modal-close" onclick="closeCreateBoardModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="create-board-form">
                    <div class="form-group">
                        <label class="form-label" for="board-name">Board Name</label>
                        <input type="text" id="board-name" class="form-input" placeholder="Enter board name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="board-description">Description (Optional)</label>
                        <textarea id="board-description" class="form-input" rows="3" placeholder="Enter board description"></textarea>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="board-public">
                            <span class="form-label" style="margin-bottom: 0;">Make this board public</span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCreateBoardModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitCreateBoard()">Create Board</button>
            </div>
        </div>
    </div>

    <script src="/static/js/api.js"></script>
    <script>
        let currentUser = null;

        async function init() {
            try {
                currentUser = await api.getCurrentUser();
                document.getElementById('user-name').textContent = currentUser.username;
                await loadBoards();
            } catch (error) {
                console.error('Failed to load user:', error);
                window.location.href = '/login';
            }
        }

        async function loadBoards() {
            const boardsGrid = document.getElementById('boards-grid');
            try {
                const boards = await api.getBoards();
                
                if (boards.length === 0) {
                    boardsGrid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 4rem; color: var(--text-secondary);">
                            <p style="font-size: 1.25rem; margin-bottom: 1rem;">No boards yet</p>
                            <p>Create your first board to get started!</p>
                        </div>
                    `;
                    return;
                }

                boardsGrid.innerHTML = boards.map(board => `
                    <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="openBoard('${board.id}')">
                        <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">
                            ${board.name}
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1rem;">
                            ${board.description || 'No description'}
                        </p>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: var(--text-tertiary);">
                            <span>${new Date(board.created_at).toLocaleDateString()}</span>
                            ${board.is_public ? '<span class="badge badge-primary">Public</span>' : '<span class="badge">Private</span>'}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load boards:', error);
                boardsGrid.innerHTML = `
                    <div class="alert alert-error" style="grid-column: 1/-1;">
                        Failed to load boards. Please try again.
                    </div>
                `;
            }
        }

        function openBoard(boardId) {
            window.location.href = `/board/${boardId}`;
        }

        function openCreateBoardModal() {
            document.getElementById('create-board-modal').classList.remove('hidden');
        }

        function closeCreateBoardModal() {
            document.getElementById('create-board-modal').classList.add('hidden');
            document.getElementById('create-board-form').reset();
        }

        async function submitCreateBoard() {
            const name = document.getElementById('board-name').value;
            const description = document.getElementById('board-description').value;
            const isPublic = document.getElementById('board-public').checked;

            try {
                await api.createBoard({
                    name,
                    description: description || null,
                    is_public: isPublic
                });
                closeCreateBoardModal();
                await loadBoards();
            } catch (error) {
                console.error('Failed to create board:', error);
                alert('Failed to create board: ' + error.message);
            }
        }

        document.getElementById('create-board-btn').addEventListener('click', openCreateBoardModal);
        document.getElementById('logout-btn').addEventListener('click', () => {
            api.logout();
        });

        // Close modal when clicking outside
        document.getElementById('create-board-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeCreateBoardModal();
            }
        });

        init();
    </script>
</body>
</html>
