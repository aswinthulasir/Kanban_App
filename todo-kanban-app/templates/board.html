<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Board - TodoKanban</title>
    <link rel="stylesheet" href="/static/css/reset.css">
    <link rel="stylesheet" href="/static/css/variables.css">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/board.css">
    <link rel="stylesheet" href="/static/css/components.css">
</head>
<body>
    <nav class="navbar">
        <div class="container navbar-content">
            <div class="navbar-brand">
                <a href="/" style="color: var(--accent-primary); text-decoration: none;">TodoKanban</a>
            </div>
            <div class="navbar-nav">
                <span id="user-name" class="nav-link"></span>
                <button id="logout-btn" class="btn btn-secondary">Logout</button>
            </div>
        </div>
    </nav>

    <main class="container" style="padding-top: 2rem;">
        <div class="board-header">
            <div>
                <h1 id="board-title" class="board-title">Loading...</h1>
                <p id="board-description" style="color: var(--text-secondary);"></p>
            </div>
            <div class="board-actions">
                <button id="add-column-btn" class="btn btn-secondary">+ Add Column</button>
            </div>
        </div>

        <div id="kanban-board" class="kanban-board">
            <div class="spinner"></div>
        </div>
    </main>

    <!-- Add Column Modal -->
    <div id="add-column-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add Column</h2>
                <button class="modal-close" onclick="closeAddColumnModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-column-form">
                    <div class="form-group">
                        <label class="form-label">Column Name</label>
                        <input type="text" id="column-name" class="form-input" placeholder="e.g., To Do, In Progress, Done" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Color (Optional)</label>
                        <input type="color" id="column-color" class="form-input" value="#3b82f6">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddColumnModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitAddColumn()">Add Column</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Task Modal -->
    <div id="task-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2 id="task-modal-title" class="modal-title">Add Task</h2>
                <button class="modal-close" onclick="closeTaskModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="task-form">
                    <input type="hidden" id="task-id">
                    <input type="hidden" id="task-column-id">
                    
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" id="task-title" class="form-input" placeholder="Enter task title" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="task-description" class="form-input" rows="3" placeholder="Enter task description"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select id="task-priority" class="form-input">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Due Date (Optional)</label>
                        <input type="datetime-local" id="task-due-date" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tags (comma-separated)</label>
                        <input type="text" id="task-tags" class="form-input" placeholder="e.g., frontend, urgent, bug">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="delete-task-btn" onclick="deleteTask()" style="margin-right: auto; display: none;">Delete</button>
                <button class="btn btn-secondary" onclick="closeTaskModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitTask()">Save Task</button>
            </div>
        </div>
    </div>

    <script src="/static/js/api.js"></script>
    <script>
        const boardId = window.location.pathname.split('/').pop();
        let currentUser = null;
        let board = null;
        let columns = [];
        let tasks = [];
        let ws = null;

        async function init() {
            try {
                currentUser = await api.getCurrentUser();
                document.getElementById('user-name').textContent = currentUser.username;
                
                await loadBoard();
                await loadColumns();
                await loadTasks();
                renderBoard();
                
                // Connect WebSocket
                connectWebSocket();
            } catch (error) {
                console.error('Failed to initialize:', error);
                window.location.href = '/login';
            }
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/board/${boardId}`);
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('WebSocket message:', data);
                
                // Handle real-time updates
                if (data.type === 'task_update') {
                    loadTasks().then(() => renderBoard());
                } else if (data.type === 'column_update') {
                    loadColumns().then(() => loadTasks()).then(() => renderBoard());
                }
            };
            
            ws.onclose = () => {
                console.log('WebSocket closed, reconnecting...');
                setTimeout(connectWebSocket, 3000);
            };
        }

        async function loadBoard() {
            board = await api.getBoard(boardId);
            document.getElementById('board-title').textContent = board.name;
            document.getElementById('board-description').textContent = board.description || '';
        }

        async function loadColumns() {
            columns = await api.getBoardColumns(boardId);
            columns.sort((a, b) => a.position - b.position);
        }

        async function loadTasks() {
            tasks = await api.getTasks(boardId);
        }

        function renderBoard() {
            const kanbanBoard = document.getElementById('kanban-board');
            
            if (columns.length === 0) {
                kanbanBoard.innerHTML = `
                    <div style="text-align: center; padding: 4rem; color: var(--text-secondary);">
                        <p style="font-size: 1.25rem; margin-bottom: 1rem;">No columns yet</p>
                        <p>Add your first column to start organizing tasks!</p>
                    </div>
                `;
                return;
            }

            kanbanBoard.innerHTML = columns.map(column => {
                const columnTasks = tasks.filter(t => t.column_id === column.id);
                
                return `
                    <div class="kanban-column" data-column-id="${column.id}">
                        <div class="column-header">
                            <div class="column-title">
                                ${column.name}
                                <span class="column-count">${columnTasks.length}</span>
                            </div>
                        </div>
                        <div class="column-tasks">
                            ${columnTasks.map(task => `
                                <div class="task-card" data-task-id="${task.id}" onclick="editTask('${task.id}')">
                                    <div class="task-priority priority-${task.priority}">${task.priority}</div>
                                    <div class="task-title">${task.title}</div>
                                    ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                                    ${task.tags && task.tags.length > 0 ? `
                                        <div class="task-tags">
                                            ${task.tags.map(tag => `<span class="task-tag">${tag}</span>`).join('')}
                                        </div>
                                    ` : ''}
                                    <div class="task-meta">
                                        <span>${new Date(task.created_at).toLocaleDateString()}</span>
                                        ${task.due_date ? `<span>Due: ${new Date(task.due_date).toLocaleDateString()}</span>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button class="add-task-btn" onclick="openAddTaskModal('${column.id}')">+ Add Task</button>
                    </div>
                `;
            }).join('');
        }

        function openAddColumnModal() {
            document.getElementById('add-column-modal').classList.remove('hidden');
        }

        function closeAddColumnModal() {
            document.getElementById('add-column-modal').classList.add('hidden');
            document.getElementById('add-column-form').reset();
        }

        async function submitAddColumn() {
            const name = document.getElementById('column-name').value;
            const color = document.getElementById('column-color').value;

            try {
                await api.createColumn({
                    name,
                    board_id: boardId,
                    position: columns.length,
                    color
                });
                
                closeAddColumnModal();
                await loadColumns();
                await loadTasks();
                renderBoard();
                
                // Broadcast update
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'column_update' }));
                }
            } catch (error) {
                console.error('Failed to create column:', error);
                alert('Failed to create column: ' + error.message);
            }
        }

        function openAddTaskModal(columnId) {
            document.getElementById('task-modal-title').textContent = 'Add Task';
            document.getElementById('task-id').value = '';
            document.getElementById('task-column-id').value = columnId;
            document.getElementById('delete-task-btn').style.display = 'none';
            document.getElementById('task-form').reset();
            document.getElementById('task-modal').classList.remove('hidden');
        }

        async function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            document.getElementById('task-modal-title').textContent = 'Edit Task';
            document.getElementById('task-id').value = task.id;
            document.getElementById('task-column-id').value = task.column_id;
            document.getElementById('task-title').value = task.title;
            document.getElementById('task-description').value = task.description || '';
            document.getElementById('task-priority').value = task.priority;
            document.getElementById('task-tags').value = task.tags ? task.tags.join(', ') : '';
            
            if (task.due_date) {
                const date = new Date(task.due_date);
                document.getElementById('task-due-date').value = date.toISOString().slice(0, 16);
            }
            
            document.getElementById('delete-task-btn').style.display = 'block';
            document.getElementById('task-modal').classList.remove('hidden');
        }

        function closeTaskModal() {
            document.getElementById('task-modal').classList.add('hidden');
            document.getElementById('task-form').reset();
        }

        async function submitTask() {
            const taskId = document.getElementById('task-id').value;
            const columnId = document.getElementById('task-column-id').value;
            const title = document.getElementById('task-title').value;
            const description = document.getElementById('task-description').value;
            const priority = document.getElementById('task-priority').value;
            const dueDate = document.getElementById('task-due-date').value;
            const tagsInput = document.getElementById('task-tags').value;
            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

            const taskData = {
                title,
                description: description || null,
                priority,
                due_date: dueDate || null,
                tags: tags.length > 0 ? tags : null
            };

            try {
                if (taskId) {
                    // Update existing task
                    await api.updateTask(taskId, taskData);
                } else {
                    // Create new task
                    await api.createTask({
                        ...taskData,
                        column_id: columnId,
                        board_id: boardId,
                        position: tasks.filter(t => t.column_id === columnId).length
                    });
                }
                
                closeTaskModal();
                await loadTasks();
                renderBoard();
                
                // Broadcast update
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'task_update' }));
                }
            } catch (error) {
                console.error('Failed to save task:', error);
                alert('Failed to save task: ' + error.message);
            }
        }

        async function deleteTask() {
            const taskId = document.getElementById('task-id').value;
            if (!taskId) return;

            if (!confirm('Are you sure you want to delete this task?')) return;

            try {
                await api.deleteTask(taskId);
                closeTaskModal();
                await loadTasks();
                renderBoard();
                
                // Broadcast update
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'task_update' }));
                }
            } catch (error) {
                console.error('Failed to delete task:', error);
                alert('Failed to delete task: ' + error.message);
            }
        }

        // Event listeners
        document.getElementById('add-column-btn').addEventListener('click', openAddColumnModal);
        document.getElementById('logout-btn').addEventListener('click', () => api.logout());

        // Close modals when clicking outside
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    e.target.classList.add('hidden');
                }
            });
        });

        // Initialize
        init();
    </script>
</body>
</html>
